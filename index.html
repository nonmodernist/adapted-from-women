<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Adaptation Research Database</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
    <div class="container">
        <div class="nav-links">
            <a href="index.html" class="active">Home</a>
            <a href="about.html">About</a>
            <a href="visualizations.html">Visualizations</a>
        </div>
    </div>
</nav>
    <header>
        <div class="container">
            <h1>Adapted from American Women</h1>
            <p>Research Database â€¢ 1910-1962</p>
        </div>
    </header>
    
    <div class="container">
        <div class="search-section">
            <div class="search-controls">
                <div class="search-group">
                    <label for="search">Search</label>
                    <input type="text" id="search" placeholder="Search films, authors, or source works...">
                </div>
                <div class="search-group">
                    <label for="yearFilter">Year</label>
                    <select id="yearFilter">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="authorFilter">Author</label>
                    <select id="authorFilter">
                        <option value="">All Authors</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="genreFilter">Genre</label>
                    <select id="genreFilter">
                        <option value="">All Genres</option>
                    </select>
                </div>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" data-view="card">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <rect x="2" y="2" width="7" height="7"/>
                        <rect x="11" y="2" width="7" height="7"/>
                        <rect x="2" y="11" width="7" height="7"/>
                        <rect x="11" y="11" width="7" height="7"/>
                    </svg>
                    Card View
                </button>
                <button class="view-btn" data-view="list">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <rect x="2" y="4" width="16" height="2"/>
                        <rect x="2" y="9" width="16" height="2"/>
                        <rect x="2" y="14" width="16" height="2"/>
                    </svg>
                    List View
                </button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Films</h3>
                <div class="number" id="filmCount">-</div>
            </div>
            <div class="stat-card">
                <h3>Authors</h3>
                <div class="number" id="authorCount">-</div>
            </div>
            <div class="stat-card">
                <h3>Source Works</h3>
                <div class="number" id="workCount">-</div>
            </div>
        </div>
        
        <div id="filmGrid" class="film-grid">
            <div class="loading">Loading database...</div>
        </div>
        
        <div id="filmList" class="film-list" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Year</th>
                        <th>Director</th>
                        <th>Source Work</th>
                        <th>Author</th>
                        <th>Delay</th>
                        <th>Genres</th>
                        <th>AFI</th>
                    </tr>
                </thead>
                <tbody id="filmTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="filmModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
        // Configuration
        const DATA_BASE_PATH = '/adapted-from-women/data/';
        const CSV_FILES = {
            films: 'films_rows.csv',
            authors: 'authors_rows.csv',
            sourceWorks: 'source_works_rows.csv'
        };
        
        // Data storage
        let data = {
            films: [],
            authors: [],
            sourceWorks: []
        };
        
        // View state
        let currentView = 'card';
        
        // Create lookup maps for performance
        let authorMap = {};
        let workMap = {};
        
        // Parse pipe-separated values
        function parsePipeSeparated(value) {
            if (!value) return '';
            return value.split('|').join(', ');
        }
        
        // Parse genres from string that might contain JSON array or comma-separated list
        function parseGenres(genreString) {
            if (!genreString) return [];
            
            // Try to parse as JSON array first
            if (genreString.startsWith('[')) {
                try {
                    return JSON.parse(genreString);
                } catch (e) {
                    // If JSON parse fails, fall back to comma separation
                }
            }
            
            // Otherwise treat as comma-separated
            return genreString.split(',').map(g => g.trim());
        }
        
        // Format genres for display
        function formatGenres(genreString) {
            const genres = parseGenres(genreString);
            return genres.join(', ');
        }
        
        // Generate AFI Catalog URL
        function getAFICatalogURL(afiId) {
            if (!afiId) return null;
            // AFI Catalog URL pattern - adjust if needed based on actual AFI URLs
            return `https://catalog.afi.com/Catalog/moviedetails/${afiId}`;
        }
        
        // Load CSV from URL using PapaParse
        async function loadCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log(`Loaded ${results.data.length} rows from ${url}`);
                        resolve(results.data);
                    },
                    error: function(error) {
                        console.error(`Error loading ${url}:`, error);
                        reject(error);
                    }
                });
            });
        }
        
        // Load all data
        async function loadData() {
            try {
                // Show loading state
                document.getElementById('filmGrid').innerHTML = '<div class="loading">Loading database...</div>';
                
                // Load all CSV files
                const [filmsData, authorsData, worksData] = await Promise.all([
                    loadCSV(DATA_BASE_PATH + CSV_FILES.films),
                    loadCSV(DATA_BASE_PATH + CSV_FILES.authors),
                    loadCSV(DATA_BASE_PATH + CSV_FILES.sourceWorks)
                ]);
                
                // Store data
                data.films = filmsData;
                data.authors = authorsData;
                data.sourceWorks = worksData;
                
                // Create lookup maps
                data.authors.forEach(author => {
                    authorMap[author.id] = author;
                });
                
                data.sourceWorks.forEach(work => {
                    workMap[work.id] = work;
                });
                
                // Initialize UI
                analyzeAdaptations();
                initializeFilters();
                updateStats();
                renderFilms();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('filmGrid').innerHTML = `
                    <div class="error">
                        Error loading data. Please ensure CSV files are in the correct location:<br>
                        ${DATA_BASE_PATH}${CSV_FILES.films}<br>
                        ${DATA_BASE_PATH}${CSV_FILES.authors}<br>
                        ${DATA_BASE_PATH}${CSV_FILES.sourceWorks}
                    </div>
                `;
            }
        }
        
        // Initialize filters
        function initializeFilters() {
            // Year filter
            const years = [...new Set(data.films.map(f => f.release_year))].filter(y => y).sort((a, b) => b - a);
            const yearSelect = document.getElementById('yearFilter');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Author filter
            const authorSelect = document.getElementById('authorFilter');
            data.authors.sort((a, b) => (a.name || '').localeCompare(b.name || '')).forEach(author => {
                if (author.name) {
                    const option = document.createElement('option');
                    option.value = author.id;
                    option.textContent = author.name;
                    authorSelect.appendChild(option);
                }
            });
            
            // Genre filter
            const genres = new Set();
            data.films.forEach(film => {
                parseGenres(film.genres).forEach(g => genres.add(g));
            });
            const genreSelect = document.getElementById('genreFilter');
            [...genres].sort().forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });
        }
        
        // Track multiple adaptations
        let multipleAdaptations = {};
        
        // Analyze adaptations
        function analyzeAdaptations() {
            // Find works with multiple adaptations
            const adaptationCounts = {};
            data.films.forEach(film => {
                if (film.source_work_id) {
                    adaptationCounts[film.source_work_id] = (adaptationCounts[film.source_work_id] || 0) + 1;
                }
            });
            
            // Store works with multiple adaptations
            Object.entries(adaptationCounts).forEach(([workId, count]) => {
                if (count > 1) {
                    multipleAdaptations[workId] = count;
                }
            });
        }
        
        // Calculate years between publication and adaptation
        function getAdaptationDelay(work, film) {
            if (work && work.publication_year && film.release_year) {
                return film.release_year - work.publication_year;
            }
            return null;
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('filmCount').textContent = data.films.length;
            document.getElementById('authorCount').textContent = data.authors.length;
            document.getElementById('workCount').textContent = data.sourceWorks.length;
        }
        
        // Filter films
        function filterFilms() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const yearFilter = document.getElementById('yearFilter').value;
            const authorFilter = document.getElementById('authorFilter').value;
            const genreFilter = document.getElementById('genreFilter').value;
            
            const filtered = data.films.filter(film => {
                // Search filter
                if (searchTerm) {
                    const work = workMap[film.source_work_id];
                    const author = work ? authorMap[work.author_id] : null;
                    
                    const searchMatch = 
                        (film.title || '').toLowerCase().includes(searchTerm) ||
                        (work && (work.title || '').toLowerCase().includes(searchTerm)) ||
                        (author && (author.name || '').toLowerCase().includes(searchTerm));
                    
                    if (!searchMatch) return false;
                }
                
                // Year filter
                if (yearFilter && film.release_year != yearFilter) return false;
                
                // Author filter
                if (authorFilter) {
                    const work = workMap[film.source_work_id];
                    if (!work || work.author_id != authorFilter) return false;
                }
                
                // Genre filter
                if (genreFilter) {
                    const genres = parseGenres(film.genres);
                    if (!genres.includes(genreFilter)) return false;
                }
                
                return true;
            });
            
            // Sort by year (ascending)
            return filtered.sort((a, b) => {
                // Handle missing years by putting them at the end
                if (!a.release_year && !b.release_year) return 0;
                if (!a.release_year) return 1;
                if (!b.release_year) return -1;
                return a.release_year - b.release_year;
            });
        }
        
        // Render films based on current view
        function renderFilms() {
            if (currentView === 'card') {
                renderCardView();
            } else {
                renderListView();
            }
        }
        
        // Render card view
        function renderCardView() {
            const filmGrid = document.getElementById('filmGrid');
            const filteredFilms = filterFilms();
            
            if (filteredFilms.length === 0) {
                filmGrid.innerHTML = '<div class="loading">No films found matching your criteria.</div>';
                return;
            }
            
            filmGrid.innerHTML = filteredFilms.map(film => {
                const work = workMap[film.source_work_id];
                const author = work ? authorMap[work.author_id] : null;
                const genres = parseGenres(film.genres);
                const adaptationDelay = getAdaptationDelay(work, film);
                const hasMultipleAdaptations = multipleAdaptations[film.source_work_id];
                
                return `
                    <div class="film-card" onclick="showFilmDetails(${film.id})">
                        <h3>${film.title || 'Untitled'}</h3>
                        <div class="film-year">${film.release_year || 'Year unknown'}</div>
                        ${film.directors ? `<div class="film-credits"><strong>Director:</strong> ${parsePipeSeparated(film.directors)}</div>` : ''}
                        ${film.writers ? `<div class="film-credits"><strong>Writer:</strong> ${parsePipeSeparated(film.writers)}</div>` : ''}
                        <div class="film-details">
                            ${film.country_of_production ? `<strong>Country:</strong> ${film.country_of_production}<br>` : ''}
                            ${film.adaptation_type ? `<strong>Type:</strong> ${film.adaptation_type}` : ''}
                        </div>
                        ${work ? `
                            <div class="film-source">
                                <strong>Based on:</strong> "${work.title || 'Unknown'}"<br>
                                <strong>Author:</strong> 
                                <span class="author-link">${author ? author.name : 'Unknown'}</span>
                                ${adaptationDelay !== null ? `<br><small class="adaptation-delay">Adapted ${adaptationDelay} years after publication</small>` : ''}
                                ${hasMultipleAdaptations ? `<br><span class="multiple-adaptations">One of ${hasMultipleAdaptations} film adaptations</span>` : ''}
                            </div>
                        ` : ''}
                        ${genres.length > 0 ? `
                            <div class="tags">
                                ${genres.map(g => `<span class="tag">${g}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${film.afi_catalog_id ? `
                            <div class="afi-link">
                                <a href="${getAFICatalogURL(film.afi_catalog_id)}" target="_blank" onclick="event.stopPropagation()">
                                    View in AFI Catalog â†’
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Render list view
        function renderListView() {
            const tbody = document.getElementById('filmTableBody');
            const filteredFilms = filterFilms();
            
            tbody.innerHTML = filteredFilms.map(film => {
                const work = workMap[film.source_work_id];
                const author = work ? authorMap[work.author_id] : null;
                const genres = formatGenres(film.genres);
                const adaptationDelay = getAdaptationDelay(work, film);
                const hasMultipleAdaptations = multipleAdaptations[film.source_work_id];
                
                return `
                    <tr onclick="showFilmDetails(${film.id})">
                        <td>
                            ${film.title || 'Untitled'}
                            ${hasMultipleAdaptations ? '<span class="adaptation-badge" title="Multiple adaptations exist">â˜…</span>' : ''}
                        </td>
                        <td>${film.release_year || '-'}</td>
                        <td>${film.directors ? parsePipeSeparated(film.directors) : '-'}</td>
                        <td>${work ? work.title : '-'}</td>
                        <td>${author ? author.name : '-'}</td>
                        <td>${adaptationDelay !== null ? adaptationDelay + ' yrs' : '-'}</td>
                        <td>${genres || '-'}</td>
                        <td>
                            ${film.afi_catalog_id ? `
                                <a href="${getAFICatalogURL(film.afi_catalog_id)}" target="_blank" onclick="event.stopPropagation()">
                                    View
                                </a>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Toggle view
        function toggleView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            // Show/hide appropriate containers
            document.getElementById('filmGrid').style.display = view === 'card' ? 'grid' : 'none';
            document.getElementById('filmList').style.display = view === 'list' ? 'block' : 'none';
            
            // Re-render
            renderFilms();
        }
        
        // Show film details modal
        function showFilmDetails(filmId) {
            const film = data.films.find(f => f.id === filmId);
            if (!film) return;
            
            const work = workMap[film.source_work_id];
            const author = work ? authorMap[work.author_id] : null;
            const genres = formatGenres(film.genres);
            const adaptationDelay = getAdaptationDelay(work, film);
            
            // Find other adaptations of the same work
            const otherAdaptations = work ? data.films.filter(f => 
                f.source_work_id === film.source_work_id && f.id !== film.id
            ) : [];
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h2>${film.title || 'Untitled'} (${film.release_year || 'Year unknown'})</h2>
                
                <div class="modal-section">
                    <h3>Film Details</h3>
                    ${film.studio ? `<p><strong>Studio:</strong> ${film.studio}</p>` : ''}
                    ${film.directors ? `<p><strong>Director(s):</strong> ${parsePipeSeparated(film.directors)}</p>` : ''}
                    ${film.writers ? `<p><strong>Screenwriter(s):</strong> ${parsePipeSeparated(film.writers)}</p>` : ''}
                    ${film.cast_members ? `<p><strong>Cast:</strong> ${parsePipeSeparated(film.cast_members)}</p>` : ''}
                    ${film.runtime_minutes ? `<p><strong>Runtime:</strong> ${film.runtime_minutes} minutes</p>` : ''}
                    ${film.country_of_production ? `<p><strong>Country:</strong> ${film.country_of_production}</p>` : ''}
                    ${film.color_info ? `<p><strong>Color:</strong> ${film.color_info}</p>` : ''}
                    ${film.language ? `<p><strong>Language:</strong> ${film.language}</p>` : ''}
                    ${film.adaptation_type ? `<p><strong>Adaptation Type:</strong> ${film.adaptation_type}</p>` : ''}
                    ${genres ? `<p><strong>Genres:</strong> ${genres}</p>` : ''}
                    ${film.adaptation_notes ? `<p><strong>Notes:</strong> ${film.adaptation_notes}</p>` : ''}
                    ${film.imdb_id ? `<p><strong>IMDb:</strong> <a href="https://www.imdb.com/title/${film.imdb_id}" target="_blank">${film.imdb_id}</a></p>` : ''}
                    ${film.afi_catalog_id ? `<p><strong>AFI Catalog:</strong> <a href="${getAFICatalogURL(film.afi_catalog_id)}" target="_blank">View Record</a></p>` : ''}
                </div>
                
                ${work ? `
                    <div class="modal-section">
                        <h3>Source Work</h3>
                        <p><strong>Title:</strong> ${work.title || 'Unknown'}</p>
                        ${work.publication_year ? `<p><strong>Publication Year:</strong> ${work.publication_year}</p>` : ''}
                        ${adaptationDelay !== null ? `<p><strong>Years to Adaptation:</strong> ${adaptationDelay} years</p>` : ''}
                        ${work.genre ? `<p><strong>Genre:</strong> ${work.genre}</p>` : ''}
                        ${work.plot_summary ? `<p><strong>Plot Summary:</strong> ${work.plot_summary}</p>` : ''}
                        ${work.literary_significance ? `<p><strong>Literary Significance:</strong> ${work.literary_significance}</p>` : ''}
                        ${work.attribution_notes ? `<p><strong>Attribution Notes:</strong> ${work.attribution_notes}</p>` : ''}
                    </div>
                ` : ''}
                
                ${otherAdaptations.length > 0 ? `
                    <div class="modal-section">
                        <h3>Other Film Adaptations of This Work</h3>
                        <div class="other-adaptations">
                            ${otherAdaptations.map(adaptation => `
                                <div class="adaptation-item" onclick="showFilmDetails(${adaptation.id})">
                                    <strong>${adaptation.title}</strong> (${adaptation.release_year || 'Year unknown'})
                                    ${adaptation.directors ? `<br><small>Dir: ${adaptation.directors}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${author ? `
                    <div class="modal-section">
                        <h3>Author</h3>
                        <p><strong>Name:</strong> ${author.name || 'Unknown'}</p>
                        ${author.birth_year || author.death_year ? `<p><strong>Lived:</strong> ${author.birth_year || '?'} - ${author.death_year || '?'}</p>` : ''}
                        ${author.nationality ? `<p><strong>Country:</strong> ${author.nationality}</p>` : ''}
                        ${author.literary_movement ? `<p><strong>Movement:</strong> ${author.literary_movement}</p>` : ''}
                        ${author.biographical_notes ? `<p><strong>Biography:</strong> ${author.biographical_notes}</p>` : ''}
                        ${author.author_notes ? `<p><strong>Research Notes:</strong> ${author.author_notes}</p>` : ''}
                    </div>
                ` : ''}
                
                <div class="modal-section">
                    <h3>Academic Citations</h3>
                    <div class="citation-placeholder">
                        <p>Citation functionality coming soon!</p>
                        <p>This section will display academic papers, articles, and books that discuss this film adaptation.</p>
                    </div>
                </div>
                
                ${film.updated_at ? `
                    <div class="modal-section">
                        <p class="last-updated">
                            Last updated: ${new Date(film.updated_at).toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </p>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('filmModal').style.display = 'block';
        }
        
        // Event listeners
        document.getElementById('search').addEventListener('input', renderFilms);
        document.getElementById('yearFilter').addEventListener('change', renderFilms);
        document.getElementById('authorFilter').addEventListener('change', renderFilms);
        document.getElementById('genreFilter').addEventListener('change', renderFilms);
        
        // View toggle listeners
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => toggleView(btn.dataset.view));
        });
        
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('filmModal').style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('filmModal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Initialize on load
        loadData();
    </script>
</body>
</html>